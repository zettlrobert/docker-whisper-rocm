services:
  whisper:
    build: .
    image: whisper-rocm
    container_name: whisper-ai-rocm
    volumes:
      - .:/app
      - ${HOME}:${HOME}
      # Mounts a local 'models' folder to the container's whisper cache
      - ./models:${HOME}/.cache/whisper
      # Fix MiOpen permission error by mounting config directory with proper permissions
      - ./config/miopen:${HOME}/.config/miopen:rw
    working_dir: ${HOME}
    devices:
      - /dev/kfd:/dev/kfd:rwm
      - /dev/dri:/dev/dri:rwm
    security_opt:
      - seccomp:unconfined
    group_add:
      - "${VIDEO_GID:-44}"
      - "${RENDER_GID:-110}"
    ipc: host
    shm_size: 16G
    environment:
      - HOME=${HOME}
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.0.0}
      - TORCH_CUDA_ARCH_LIST=${TORCH_CUDA_ARCH_LIST}
      - MIOPEN_USER_DB_PATH=${HOME}/.config/miopen/miopen-user.db
      - MIOPEN_CUSTOM_CACHE_DIR=${HOME}/.config/miopen
