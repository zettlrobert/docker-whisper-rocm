services:
  whisper:
    build: .
    image: whisper-rocm
    container_name: whisper-ai-rocm
    # Keeps the container alive so you can 'exec' into it instantly
    command: sleep infinity
    # This maps the container's internal user to YOUR local user
    user: "${UID}:${GID}"
    volumes:
      - .:/app
      # Mount home directory (Read-Write so it can save transcriptions)
      - ${HOME}:${HOME}
    # Standard working directory inside the container
    working_dir: ${HOME}
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    security_opt:
      - seccomp:unconfined
    group_add:
      - video
      - render
    ipc: host
    shm_size: 8G
    environment:
      - HSA_OVERRIDE_GFX_VERSION=11.0.0
      - HOME=${HOME}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python3 -c 'import torch; exit(0) if torch.cuda.is_available() else exit(1)'",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
