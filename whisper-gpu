#!/usr/bin/env bash

# Auto-detect DOCKER_WHISPER_ROCM_DIR (scoped path detection from ~/.local/bin)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"

if [[ "$SCRIPT_DIR" == *".local/bin"* ]]; then
    DOCKER_WHISPER_ROCM_DIR=""
    
    # Search upward from ~/.local/bin (max 10 levels)
    SEARCH_DIR="$SCRIPT_DIR"
    for i in {1..10}; do
        PARENT=$(dirname "$SEARCH_DIR")
        if [ "$PARENT" == "$SEARCH_DIR" ]; then
            break
        fi
        if [ -f "$PARENT/docker-compose.yml" ] && [ -d "$PARENT/.git" ]; then
            DOCKER_WHISPER_ROCM_DIR="$PARENT"
            break
        fi
        SEARCH_DIR="$PARENT"
    done
    
    # Fallback: search $HOME for docker-whisper-rocm directory (maxdepth 5)
    if [ -z "$DOCKER_WHISPER_ROCM_DIR" ]; then
        SEARCH_RESULT=$(find "$HOME" -maxdepth 5 -name "docker-whisper-rocm" -type d 2>/dev/null | head -1)
        if [ -n "$SEARCH_RESULT" ] && [ -f "$SEARCH_RESULT/docker-compose.yml" ]; then
            DOCKER_WHISPER_ROCM_DIR="$SEARCH_RESULT"
        fi
    fi
    
    # Final validation
    if [ -z "$DOCKER_WHISPER_ROCM_DIR" ]; then
        echo "âŒ Error: Could not detect docker-whisper-rocm directory"
        echo "Please ensure the repository exists in your home directory."
        exit 1
    fi
    
    SCRIPT_DIR="$DOCKER_WHISPER_ROCM_DIR"
else
    DOCKER_WHISPER_ROCM_DIR="$SCRIPT_DIR"
fi

export DOCKER_WHISPER_ROCM_DIR

# Expand any ~ in file paths to absolute paths  
EXPANDED_ARGS=()
for arg in "$@"; do
  if [[ "$arg" == "~"* ]]; then
    EXPANDED_ARGS+=("${arg/#~/$HOME}")
  else
    EXPANDED_ARGS+=("$arg")
  fi
done

# Only rebuild if image doesn't exist (saves time on repeated runs)
if docker image inspect whisper-rocm:latest &>/dev/null; then
    echo "âœ… Image exists, skipping build"
else
    echo "ðŸ›  Building Docker image..."
    cd "$SCRIPT_DIR"
    docker compose build --progress plain
fi

# Run whisper with expanded arguments  
echo "ðŸŽ™ Running whisper transcription..."
docker compose -f "${SCRIPT_DIR}/docker-compose.yml" run --rm --user "$(id -u):$(id -g)" whisper whisper "${EXPANDED_ARGS[@]}"
